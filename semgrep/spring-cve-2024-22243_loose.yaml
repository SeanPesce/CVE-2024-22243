# Author: Sean Pesce


rules:


# Basic search for direct calls to UriComponentsBuilder.fromUriString, etc.
#rules:
- id: cve-2024-22243-uricomponentsbuilder_loose
  languages:
    - java
  options:
    interfile: true
  patterns:
  - pattern: $CLAZZ. ... .$FUNC(...)
  - pattern-not: $CLAZZ. ... .$FUNC("...")
  - metavariable-regex:
      metavariable: $CLAZZ
      regex: ^(UriComponentsBuilder|ServletUriComponentsBuilder)$
  - metavariable-regex:
      metavariable: $FUNC
      regex: ^(fromUriString|fromHttpUrl)$
  message: >-
    Potential unsafe use of Spring UriComponentsBuilder (fromUriString/fromHttpUrl), which can cause a host name mismatch (potentially resulting in open redirect or SSRF) for specially-crafted inputs.
  severity: WARNING
  metadata:
    cwe:
    - 'CWE-601: URL Redirection to Untrusted Site (Open Redirect)'
    - 'CWE-918: Server-Side Request Forgery (SSRF)'
    source-rule-url: 'https://spring.io/security/'
    references:
    - https://spring.io/security/
    category: security
    technology:
    - java
    - spring
    likelihood: LOW
    impact: MEDIUM
    confidence: LOW
    interfile: true


# Basic search for direct calls to RestTemplate.exchange, etc.
#rules:
- id: cve-2024-22243-resttemplate_loose
  languages:
    - java
  options:
    interfile: true
  patterns:
  - pattern-either:
    # - pattern: ($CLAZZ $INST). ... .$FUNC($URISTR, ...)
    - pattern: (RestOperations $INST). ... .$FUNC($URISTR, ...)
    - pattern: (RestTemplate $INST). ... .$FUNC($URISTR, ...)
    - pattern: (InterceptingHttpAccessor $INST). ... .$FUNC($URISTR, ...)
    - pattern: (HttpAccessor $INST). ... .$FUNC($URISTR, ...)
  - pattern-not: ($CLAZZ $INST). ... .$FUNC("...", ...)
  # Having problems getting metavariables working for types of typed variables
  # - metavariable-regex:
  #     metavariable: $CLAZZ
  #     regex: ^(RestTemplate|RestOperations|InterceptingHttpAccessor|HttpAccessor)$
  - metavariable-regex:
      metavariable: $FUNC
      regex: ^(delete|doExecute|exchange|execute|getForEntity|getForObject|headForHeaders|optionsForAllow|patchForObject|postForEntity|postForLocation|postForObject|put)$
  message: >-
    Potential unsafe use of Spring RestTemplate HTTP client, which can cause a host name mismatch (potentially resulting in SSRF) for specially-crafted inputs.
  severity: WARNING
  metadata:
    cwe:
    - 'CWE-918: Server-Side Request Forgery (SSRF)'
    source-rule-url: 'https://spring.io/security/'
    references:
    - https://spring.io/security/
    category: security
    technology:
    - java
    - spring
    likelihood: LOW
    impact: MEDIUM
    confidence: LOW
    interfile: true


# Basic search for direct calls to WebClient and related classes/methods using untrusted Strings
#rules:
- id: cve-2024-22243-webclient_loose
  languages:
    - java
  options:
    interfile: true
  patterns:
  - pattern-either:
    - pattern: (WebClient $INST). ... .$FUNC((String $URISTR), ...)
    - pattern: (WebClient.Builder $INST). ... .$FUNC((String $URISTR), ...)
    - pattern: (WebClient.RequestHeadersUriSpec $INST). ... .$FUNC((String $URISTR), ...)
    - pattern: (WebClient.RequestHeadersUriSpec<?> $INST). ... .$FUNC((String $URISTR), ...)
    - pattern: (RestClient $INST). ... .$FUNC((String $URISTR), ...)
    - pattern: (RestClient.Builder $INST). ... .$FUNC((String $URISTR), ...)
    - pattern: (RestClient.RequestHeadersUriSpec $INST). ... .$FUNC((String $URISTR), ...)
    - pattern: (RestClient.RequestHeadersUriSpec<?> $INST). ... .$FUNC((String $URISTR), ...)
  - pattern-not: (WebClient $INST). ... .$FUNC("...", ...)
  - pattern-not: (WebClient.Builder $INST). ... .$FUNC("...", ...)
  - pattern-not: (WebClient.RequestHeadersUriSpec $INST). ... .$FUNC("...", ...)
  - pattern-not: (WebClient.RequestHeadersUriSpec<?> $INST). ... .$FUNC("...", ...)
  - pattern-not: (RestClient $INST). ... .$FUNC("...", ...)
  - pattern-not: (RestClient.Builder $INST). ... .$FUNC("...", ...)
  - pattern-not: (RestClient.RequestHeadersUriSpec $INST). ... .$FUNC("...", ...)
  - pattern-not: (RestClient.RequestHeadersUriSpec<?> $INST). ... .$FUNC("...", ...)
  - metavariable-regex:
      metavariable: $FUNC
      regex: ^(uri|create|baseUrl)$
  # - metavariable-pattern:
  #     metavariable: $URITYPE
  #     pattern-not-regex: ^URI$
  message: >-
    Potential unsafe use of org.springframework.web.reactive.function.client.WebClient (or RestClient), which can cause a host name mismatch (potentially resulting in SSRF) for specially-crafted inputs.
  severity: WARNING
  metadata:
    cwe:
    - 'CWE-918: Server-Side Request Forgery (SSRF)'
    source-rule-url: 'https://spring.io/security/'
    references:
    - https://spring.io/security/
    category: security
    technology:
    - java
    - spring
    likelihood: LOW
    impact: MEDIUM
    confidence: LOW
    interfile: true


